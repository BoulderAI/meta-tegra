#!/bin/sh
TARGET="@TARGET@"
BOOTDEV="@BOOTDEV@"
sysconfdir="@sysconfdir@"

if [ -e "${sysconfdir}/nv_boot_control.conf" ]; then
    echo "${sysconfdir}/nv_boot_control.conf exits and is not a broken symlink, exiting"
    exit 0
fi

if [ -h "${sysconfdir}/nv_boot_control.conf" ]; then
    nvbootlinkpath=$(readlink "${sysconfdir}/nv_boot_control.conf")
    echo "Ensuring path to symlink at ${nvbootlinkpath} exists"
    mkdir -p $(dirname "${nvbootlinkpath}")
fi

if [ ! -e "${sysconfdir}/nv_boot_control.template" ]; then
    echo "ERR: nv_boot_control.conf template file not found" >&2
    exit 1
fi

boardspec=$(tegra-boardspec 2>/dev/null)
if [ -z "${boardspec}" ]; then
    echo "ERR: could not retrieve boardspec for nv_boot_control.conf setup" >&2
    exit 1
fi

sed -e"s,@TNSPEC@,${boardspec}-${TARGET}-${BOOTDEV}," \
    "${sysconfdir}/nv_boot_control.template" > "${sysconfdir}/nv_boot_control.conf"
chmod 0644 "${sysconfdir}/nv_boot_control.conf"
exit 0

